<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galletas Deli</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sahitya:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">    
</head>
<body>
    <!-- Barra de navegación -->
    <nav>
        <div class="selection-nav">
            <a href=""><u>Ordenar</u></a>
            <a href="{{ url_for('rastreo_ordenes') }}">Rastrear</a>
        </div>        
        <div class="logo">
            <img src="{{ url_for('static', filename='images/logo_ventas.png') }}" alt="Logo">            
        </div>
        <div class="user-icon">
            <img src="{{ url_for('static', filename='images/user-icon.png') }}" alt="Usuario">
        </div>
    </nav>
    
    <!-- Contenido principal -->
    <div class="main-container">
        <!-- Lista de productos -->
        <div class="product-list">
            {% for product in products %}
            <div class="product-card" data-product-name="{{ product.name }}" data-product-image="{{ url_for('static', filename='images/' + product['image']) }}">
                <img src="{{ url_for('static', filename='images/' + product['image']) }}" alt="{{ product.name }}">
                <h3>{{ product.name }}</h3>
            </div>
            {% endfor %}
        </div>

        <!-- Resumen del pedido -->
        <div class="order-summary">
            <h2>Resumen del Pedido</h2>            
            <div id="order-details"></div>
            <p class="total" id="order-total">Total: $0.00</p>
        </div>
        <div class="order-button">
            <!-- Botón para enviar la orden -->
            <form id="order-form" method="POST" action="/crear_orden">
                <input type="hidden" name="order_summary" id="order-summary-input">
                <button type="submit">Ordenar</button>
            </form>           
        </div>
    </div>

    <!-- Modal para escoger parámetros -->
    <div class="modal" id="product-modal">
        <div class="modal-content">
            <div class="modal-header">
                <p id="selected-product"></p>
            </div>
            <div class="modal-body">    
                <div class="modal-image">                            
                    <img id="modal-product-image" src="" alt="Imagen del Producto">
                </div>
                <div class="modal-option-selection">
                    <div class="modal-option">
                        <p>Cajas de medio kilo - $100 c/u</p>
                        <div class="quantity-control">
                            <button class="decrement" data-target="half-kilo">−</button>
                            <span id="half-kilo-quantity">0</span>
                            <button class="increment" data-target="half-kilo">+</button>
                        </div>
                    </div>
                    <div class="modal-option">
                        <p>Cajas de 6 piezas - $100 c/u</p>
                        <div class="quantity-control">
                            <button class="decrement" data-target="six-pieces">−</button>
                            <span id="six-pieces-quantity">0</span>
                            <button class="increment" data-target="six-pieces">+</button>
                        </div>
                    </div>                   
                </div>
            </div>
            <button class="close-modal">Agregar</button>
        </div>
    </div>

    <script>
        const productCards = document.querySelectorAll('.product-card');
        const modal = document.getElementById('product-modal');
        const closeModalButton = document.querySelector('.close-modal');
        const selectedProductText = document.getElementById('selected-product');
        const modalImage = document.getElementById('modal-product-image');
        const orderDetails = document.getElementById('order-details');
        const orderTotal = document.getElementById('order-total');

        let currentProduct = '';
        const orderSummary = {};

        // Actualiza las cantidades en el modal
        document.querySelectorAll('.quantity-control button').forEach(button => {
            button.addEventListener('click', function () {
                const target = this.getAttribute('data-target');
                const quantityElement = document.getElementById(`${target}-quantity`);
                let quantity = parseInt(quantityElement.textContent, 10);

                if (this.classList.contains('increment')) {
                    quantity++;
                } else if (this.classList.contains('decrement') && quantity > 0) {
                    quantity--;
                }

                quantityElement.textContent = quantity;
            });
        });

        // Abre el modal cuando se selecciona un producto
        productCards.forEach(card => {
            card.addEventListener('click', () => {
                currentProduct = card.getAttribute('data-product-name');
                const productImage = card.getAttribute('data-product-image');
                selectedProductText.textContent = currentProduct;
                modalImage.src = productImage;
                modal.style.display = 'flex';

                // Resetea las cantidades del modal
                document.getElementById('half-kilo-quantity').textContent = 0;
                document.getElementById('six-pieces-quantity').textContent = 0;
            });
        });

        // Cierra el modal y actualiza el resumen del pedido
        closeModalButton.addEventListener('click', () => {
            const halfKiloQuantity = parseInt(document.getElementById('half-kilo-quantity').textContent, 10);
            const sixPiecesQuantity = parseInt(document.getElementById('six-pieces-quantity').textContent, 10);

            if (!orderSummary[currentProduct]) {
                orderSummary[currentProduct] = { halfKilo: 0, sixPieces: 0 };
            }

            orderSummary[currentProduct].halfKilo += halfKiloQuantity;
            orderSummary[currentProduct].sixPieces += sixPiecesQuantity;

            updateOrderSummary();
            modal.style.display = 'none';
        });

        // Actualiza el resumen del pedido
        function updateOrderSummary() {
            let total = 0;
            orderDetails.innerHTML = '';

            for (const [product, quantities] of Object.entries(orderSummary)) {
                if (quantities.halfKilo > 0 || quantities.sixPieces > 0) {
                    orderDetails.innerHTML += `
                        <h3>${product}</h3>
                        <p>Cajas de medio kilo: ${quantities.halfKilo}</p>
                        <p>Cajas de 6 piezas: ${quantities.sixPieces}</p>
                    `;
                    total += (quantities.halfKilo + quantities.sixPieces) * 100;
                }
            }

            orderTotal.textContent = `Total: $${total.toFixed(2)}`;
        }

        // Cierra el modal al hacer clic fuera de él
        window.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });

        // Captura el evento de clic en el botón Ordenar
        const orderForm = document.getElementById('order-form');
        const orderSummaryInput = document.getElementById('order-summary-input');

        orderForm.addEventListener('submit', (event) => {
            event.preventDefault();

            // Serializa el resumen del pedido en formato JSON
            orderSummaryInput.value = JSON.stringify(orderSummary);

            // Envía el formulario
            orderForm.submit();
        });
    </script>
</body>
</html>
